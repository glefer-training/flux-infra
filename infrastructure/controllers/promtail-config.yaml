apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: loki
data:
  promtail.yaml: |
    server:
      http_listen_port: 3101
      grpc_listen_port: 0

    positions:
      filename: /run/promtail/positions.yaml

    clients:
      - url: http://loki:3100/loki/api/v1/push

    scrape_configs:
      # Configuration par défaut pour tous les pods
      - job_name: kubernetes-pods-name
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - docker: {}
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_label_name
            target_label: __service__
          - source_labels:
              - __meta_kubernetes_pod_node_name
            target_label: __host__
          - action: drop
            regex: ''
            source_labels:
              - __service__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - action: replace
            replacement: $1
            separator: /
            source_labels:
              - __meta_kubernetes_namespace
              - __service__
            target_label: job
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: pod
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_container_name
            target_label: container
          - replacement: /var/log/pods/*$1/*.log
            separator: /
            source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
            target_label: __path__

      # Configuration spéciale pour nginx avec traitement JSON
      - job_name: nginx-glefer-json
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - glefer
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: nginx
          - source_labels: [__meta_kubernetes_pod_container_name]
            action: keep
            regex: nginx
          - source_labels: [__meta_kubernetes_pod_container_name]
            action: replace
            target_label: container
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log
          - action: replace
            source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
        pipeline_stages:
          # Ajouter le label filename pour compatibilité avec les dashboards officiels
          - static_labels:
              filename: /var/log/nginx/access.log
          # Parse JSON logs nginx
          - json:
              expressions:
                timestamp: timestamp
                remote_addr: remote_addr
                method: method
                uri: uri
                status: status
                bytes_sent: bytes_sent
                request_time: request_time
                referrer: referrer
                user_agent: user_agent
          # Labels pour Loki
          - labels:
              method:
              status:
          # Classification des status codes
          - template:
              source: status_class
              template: |
                {{- if and (ge (int .status) 200) (lt (int .status) 300) -}}2xx
                {{- else if and (ge (int .status) 300) (lt (int .status) 400) -}}3xx
                {{- else if and (ge (int .status) 400) (lt (int .status) 500) -}}4xx
                {{- else if and (ge (int .status) 500) (lt (int .status) 600) -}}5xx
                {{- else -}}other{{- end -}}
          # Ajout du label status_class
          - labels:
              status_class:
          # Métriques Prometheus dérivées des logs
          - metrics:
              nginx_http_requests_total:
                type: Counter
                description: "Total number of HTTP requests by status code"
                config:
                  value: "1"
                  action: inc
              nginx_http_request_duration_seconds:
                type: Histogram
                description: "HTTP request duration in seconds"
                source: request_time
                config:
                  buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]