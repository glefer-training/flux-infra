---
apiVersion: v1
kind: Namespace
metadata:
  name: external-dns
  labels:
    toolkit.fluxcd.io/tenant: sre-team
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: external-dns
  namespace: external-dns
spec:
  interval: 24h
  url: https://kubernetes-sigs.github.io/external-dns
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: external-dns
  namespace: external-dns
spec:
  dependsOn:
    - name: traefik
      namespace: traefik
  interval: 12h
  install:
    strategy:
      name: RetryOnFailure
      retryInterval: 2m
    createNamespace: true
  upgrade:
    strategy:
      name: RetryOnFailure
      retryInterval: 3m
  chart:
    spec:
      chart: external-dns
      version: "1.15.0"
      sourceRef:
        kind: HelmRepository
        name: external-dns
        namespace: external-dns
      interval: 12h
  values:

    image:  
      repository: docker.io/glefer/external-dns-debug
      tag: "1.0.6"

    provider:
      name: ovh
    
    env:
      - name: OVH_CONSUMER_KEY
        valueFrom:
          secretKeyRef:
            name: ovh-credentials
            key: ovh_consumer_key
      - name: OVH_APPLICATION_KEY
        valueFrom:
          secretKeyRef:
            name: ovh-credentials
            key: ovh_application_key  
      - name: OVH_APPLICATION_SECRET
        valueFrom:
          secretKeyRef:
            name: ovh-credentials
            key: ovh_application_secret
      - name: OVH_ENDPOINT
        value: "ovh-eu"
    
    policy: sync
    registry: txt
    txtOwnerId: "k3s"
    txtPrefix: "_external-dns."
    
    domainFilters:
      - glefer.fr
    
    sources:
      - ingress
    logLevel: debug
    
    extraArgs:
      - --ingress-class=traefik
    
    resources:
      requests:
        cpu: 50m
        memory: 50Mi
      limits:
        cpu: 100m
        memory: 100Mi
    
    securityContext:
      capabilities:
        drop: [ALL]
      runAsNonRoot: true
      runAsUser: 65534
      readOnlyRootFilesystem: true
