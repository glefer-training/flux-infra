apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-exporter-config
  namespace: glefer
data:
  config.yml: |
    listen:
      port: 4040
      address: "0.0.0.0"
    
    consul:
      enable: false
    
    namespaces:
      - name: nginx
        format: "$remote_addr - $remote_user [$time_local] \"$request\" $status $body_bytes_sent \"$http_referer\" \"$http_user_agent\" rt=$request_time"
        source:
          files:
            - /var/log/nginx/access.log
        labels:
          app: "nginx"
          environment: "production"
        histogram_buckets: [.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10]
        
        # MÃ©triques par status code
        metrics:
          - name: nginx_http_requests_total
            type: counter
            help: "Total number of HTTP requests"
            matches:
              - regexp: '.*'
                labels:
                  method: "$request_method"
                  status: "$status"
                  
          - name: nginx_http_request_duration_seconds
            type: histogram  
            help: "Request duration in seconds"
            matches:
              - regexp: '.*'
                value: "$request_time"
                labels:
                  method: "$request_method"
                  status: "$status"
                  
          - name: nginx_http_response_size_bytes
            type: histogram
            help: "Response size in bytes"
            matches:
              - regexp: '.*'
                value: "$body_bytes_sent"
                labels:
                  method: "$request_method"
                  status: "$status"