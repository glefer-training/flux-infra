apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: glefer
data:
  default.conf: |
    # Configuration des logs avec format JSON pour parsing
    log_format json_combined escape=json
    '{'
      '"timestamp":"$time_iso8601",'
      '"remote_addr":"$remote_addr",'
      '"method":"$request_method",'
      '"uri":"$request_uri",'
      '"status":$status,'
      '"bytes_sent":$body_bytes_sent,'
      '"request_time":$request_time,'
      '"referrer":"$http_referer",'
      '"user_agent":"$http_user_agent",'
      '"upstream_response_time":"$upstream_response_time"'
    '}';

    # Serveur principal sur port 80
    server {
        listen 80;
        server_name localhost;
        
        # Logs structurés en JSON
        access_log /var/log/nginx/access.log json_combined;
        error_log /var/log/nginx/error.log warn;
        
        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
        }
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }
    
    # Serveur pour les métriques sur port 8080
    server {
        listen 8080;
        server_name localhost;
        
        location /nginx_status {
            stub_status on;
            access_log off;
            allow all;
        }
        
        # Endpoint pour métriques détaillées (nginx-prometheus-exporter format)
        location /metrics {
            stub_status on;
            access_log off;
            allow all;
        }
        
        # Redirection pour toute autre demande
        location / {
            return 404;
        }
    }